# –î–û–ë–ê–í–¨ –≠–¢–û –í –ù–ê–ß–ê–õ–û –§–ê–ô–õ–ê, –ü–û–°–õ–ï –ò–ú–ü–û–†–¢–û–í
from telegram.ext import MessageHandler, filters
import json

# –î–û–ë–ê–í–¨ –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –í –ö–û–ù–ï–¶ –§–ê–ô–õ–ê, –ü–ï–†–ï–î main()
async def handle_web_app_data(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Mini App"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Mini App
        web_app_data = update.message.web_app_data
        if web_app_data:
            data = json.loads(web_app_data.data)
            action = data.get('action')
            user_id = data.get('user_id')
            
            user = update.effective_user
            
            if action == 'start_mining':
                await start_mining_from_webapp(update, context)
            elif action == 'activate_mining':
                await activate_mining(update, context)
            elif action == 'use_booster':
                await use_booster(update, context)
            elif action == 'copy_referral':
                await show_referrals(update)
            elif action == 'referral_stats':
                await referral_stats(update, context)
            elif action == 'withdraw':
                await check_withdraw_availability_webapp(update, context)
            elif action == 'settings':
                await show_settings(update, context)
            elif action == 'copy_wallet':
                await show_deposit_info_webapp(update, context)
            elif action == 'deposit_info':
                await show_deposit_instructions(update, context)
                
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Web App –¥–∞–Ω–Ω—ã—Ö: {e}")

# –î–û–ë–ê–í–¨ –≠–¢–ò –§–£–ù–ö–¶–ò–ò –í –ö–û–ù–ï–¶ –§–ê–ô–õ–ê
async def start_mining_from_webapp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –º–∞–π–Ω–∏–Ω–≥–∞ –∏–∑ Web App"""
    user = update.effective_user
    conn = get_db_connection()
    c = conn.cursor()
    
    user_data = c.execute("SELECT total_deposits FROM users WHERE user_id = ?", (user.id,)).fetchone()
    
    if user_data and user_data[0] > 0:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –º–∞–π–Ω–∏–Ω–≥
        random_percentage = get_random_percentage()
        full_reward = user_data[0] * random_percentage
        
        c.execute(
            "UPDATE users SET pending_mining = ?, mining_started = ?, mining_percentage = ? WHERE user_id = ?",
            (full_reward, datetime.now().strftime('%Y-%m-%d %H:%M:%S'), random_percentage, user.id)
        )
        conn.commit()
        
        await update.message.reply_text(
            f"‚úÖ –ú–∞–π–Ω–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!\n\n"
            f"üíé –ü—Ä–æ—Ü–µ–Ω—Ç: {random_percentage * 100:.2f}%\n"
            f"üí∞ –û–∂–∏–¥–∞–µ–º–∞—è –Ω–∞–≥—Ä–∞–¥–∞: {format_ton(full_reward):.6f} TON\n"
            f"‚è∞ –°–ª–µ–¥—É—é—â–∞—è –Ω–∞–≥—Ä–∞–¥–∞ —á–µ—Ä–µ–∑ 8 —á–∞—Å–æ–≤",
            reply_markup=main_keyboard()
        )
    else:
        await update.message.reply_text(
            "‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –¥–ª—è –º–∞–π–Ω–∏–Ω–≥–∞!\n"
            "üí° –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –º–∞–π–Ω–∏–Ω–≥",
            reply_markup=main_keyboard()
        )
    
    conn.close()

async def activate_mining(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–∞–π–Ω–∏–Ω–≥–∞"""
    await show_mining(update)

async def use_booster(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Å—Ç–µ—Ä–∞"""
    await update.message.reply_text(
        "üöÄ –ë—É—Å—Ç–µ—Ä x2 –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n"
        "üíé –°–ª–µ–¥—É—é—â–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –±—É–¥–µ—Ç —É–¥–≤–æ–µ–Ω–∞\n"
        "‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç 24 —á–∞—Å–∞",
        reply_markup=main_keyboard()
    )

async def referral_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤"""
    user = update.effective_user
    conn = get_db_connection()
    c = conn.cursor()
    
    ref_data = c.execute("SELECT referrals FROM users WHERE user_id = ?", (user.id,)).fetchone()
    referrals = ref_data[0] if ref_data else 0
    
    conn.close()
    
    await update.message.reply_text(
        f"üìä –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n"
        f"üë• –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: {referrals} —á–µ–ª–æ–≤–µ–∫\n"
        f"üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: {format_ton(referrals * 0.2):.6f} TON\n"
        f"üéØ –¶–µ–ª—å: 10 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤\n\n"
        f"üí° –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!",
        reply_markup=main_keyboard()
    )

async def check_withdraw_availability_webapp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–≤–æ–¥–∞ –¥–ª—è Web App"""
    await check_withdraw_availability(update, context)

async def show_settings(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏"""
    await update.message.reply_text(
        "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏\n\n"
        "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –í–∫–ª—é—á–µ–Ω—ã\n"
        "üåê –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π\n"
        "üíé –í–∞–ª—é—Ç–∞: TON\n\n"
        "üì± –í–µ—Ä—Å–∏—è Mini App: 1.0\n"
        "ü§ñ –í–µ—Ä—Å–∏—è –±–æ—Ç–∞: 2.1",
        reply_markup=main_keyboard()
    )

async def show_deposit_info_webapp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–ª—è Web App"""
    user = update.effective_user
    await update.message.reply_text(
        f"üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞\n\n"
        f"–î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤—å—Ç–µ TON –Ω–∞ –∞–¥—Ä–µ—Å:\n"
        f"`{WALLET_ADDRESS}`\n\n"
        f"üìù –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à ID: {user.id}\n\n"
        f"üí° –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç: 0.1 TON\n"
        f"‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏",
        parse_mode='Markdown',
        reply_markup=main_keyboard()
    )

async def show_deposit_instructions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é"""
    user = update.effective_user
    await update.message.reply_text(
        f"üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é:\n\n"
        f"1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à TON –∫–æ—à–µ–ª–µ–∫\n"
        f"2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ TON –Ω–∞ –∞–¥—Ä–µ—Å:\n"
        f"`{WALLET_ADDRESS}`\n\n"
        f"3. –í –ø–æ–ª–µ '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' —É–∫–∞–∂–∏—Ç–µ:\n"
        f"`{user.id}`\n\n"
        f"4. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 0.1 TON\n"
        f"5. –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç\n\n"
        f"üí° –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π",
        parse_mode='Markdown',
        reply_markup=main_keyboard()
    )
