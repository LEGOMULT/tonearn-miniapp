import sqlite3
import logging
import random
import asyncio
import csv
import io
from decimal import Decimal, ROUND_DOWN
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, ContextTypes, filters

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
TOKEN = "8501762872:AAELKL5vV1Jo4zM70SxX8oCOUf786CJvdTc"
ADMINS = [5855368265]
WALLET_ADDRESS = "UQCH1F3tgQ8yyqYHxZyFBw6_Y3tfYu91KP5ko16mM7CPaWY5"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    try:
        conn = sqlite3.connect('bot.db', check_same_thread=False)
        c = conn.cursor()
        
        c.execute('''CREATE TABLE IF NOT EXISTS users
                     (user_id INTEGER PRIMARY KEY, 
                      username TEXT,
                      balance REAL DEFAULT 0,
                      total_deposits REAL DEFAULT 0,
                      total_mined REAL DEFAULT 0,
                      pending_mining REAL DEFAULT 0,
                      mining_started TIMESTAMP,
                      mining_percentage REAL DEFAULT 0,
                      referrals INTEGER DEFAULT 0,
                      referral_code TEXT,
                      last_mining TIMESTAMP,
                      registered TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
        
        c.execute('''CREATE TABLE IF NOT EXISTS transactions
                     (id INTEGER PRIMARY KEY AUTOINCREMENT,
                      user_id INTEGER,
                      amount REAL,
                      type TEXT,
                      status TEXT DEFAULT 'completed',
                      date TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
        
        c.execute('''CREATE TABLE IF NOT EXISTS withdrawals
                     (id INTEGER PRIMARY KEY AUTOINCREMENT,
                      user_id INTEGER,
                      amount REAL,
                      wallet TEXT,
                      status TEXT DEFAULT 'completed',
                      date TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
        
        c.execute('''CREATE TABLE IF NOT EXISTS user_wallets
                     (id INTEGER PRIMARY KEY AUTOINCREMENT,
                      user_id INTEGER,
                      wallet_address TEXT,
                      is_active BOOLEAN DEFAULT 1,
                      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                      UNIQUE(user_id, wallet_address))''')
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        try:
            c.execute("SELECT mining_started FROM users LIMIT 1")
        except sqlite3.OperationalError:
            c.execute("ALTER TABLE users ADD COLUMN mining_started TIMESTAMP")
            
        try:
            c.execute("SELECT mining_percentage FROM users LIMIT 1")
        except sqlite3.OperationalError:
            c.execute("ALTER TABLE users ADD COLUMN mining_percentage REAL DEFAULT 0")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤
        for admin_id in ADMINS:
            c.execute("INSERT OR IGNORE INTO users (user_id, username) VALUES (?, ?)", 
                     (admin_id, "Admin"))
        
        conn.commit()
        conn.close()
        logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        raise

def get_db_connection():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect('bot.db', check_same_thread=False)
    return conn

def is_admin(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º"""
    return user_id in ADMINS

def format_ton(value):
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è TON"""
    try:
        if value is None:
            return 0.0
        return float(Decimal(str(value)).quantize(Decimal('0.000001'), rounding=ROUND_DOWN))
    except:
        return 0.0

def get_random_percentage():
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç 1.12% –¥–æ 1.68%"""
    return random.randint(112, 168) / 10000.0

def get_user_data(user_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã"""
    try:
        conn = get_db_connection()
        c = conn.cursor()
        
        user_data = c.execute(
            "SELECT balance, total_deposits, total_mined, pending_mining, mining_started, mining_percentage, referrals FROM users WHERE user_id = ?", 
            (user_id,)
        ).fetchone()
        
        conn.close()
        
        if user_data:
            balance, deposits, mined, pending_mining, mining_started, mining_percentage, referrals = user_data
            return {
                'balance': format_ton(balance),
                'total_deposits': format_ton(deposits),
                'total_mined': format_ton(mined),
                'pending_mining': format_ton(pending_mining),
                'mining_started': mining_started,
                'mining_percentage': mining_percentage,
                'referrals': referrals
            }
        return None
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        return None

def main_keyboard():
    return ReplyKeyboardMarkup([
        ['üè† –ì–ª–∞–≤–Ω–∞—è', '‚õèÔ∏è –ú–∞–π–Ω–∏–Ω–≥'],
        ['üë• –†–µ—Ñ–µ—Ä–∞–ª—ã', 'üë§ –ü—Ä–æ—Ñ–∏–ª—å']
    ], resize_keyboard=True)

# –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    try:
        user = update.effective_user
        conn = get_db_connection()
        c = conn.cursor()
        
        c.execute("INSERT OR IGNORE INTO users (user_id, username) VALUES (?, ?)",
                  (user.id, user.username or 'No username'))
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
        if context.args:
            referral_code = context.args[0]
            if referral_code.startswith('ref'):
                referrer_id = int(referral_code[3:])
                if referrer_id != user.id:
                    c.execute("UPDATE users SET balance = balance + 0.2, referrals = referrals + 1 WHERE user_id = ?",
                              (referrer_id,))
                    c.execute("UPDATE users SET balance = balance + 0.1 WHERE user_id = ?",
                              (user.id,))
        
        conn.commit()
        conn.close()
        
        await update.message.reply_text(
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ TonEarn!\n\n"
            "üíé –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ TON —Å –ø–æ–º–æ—â—å—é –º–∞–π–Ω–∏–Ω–≥–∞!\n"
            "üí∞ –ü–æ–ø–æ–ª–Ω—è–π—Ç–µ –±–∞–ª–∞–Ω—Å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ 1.12%-1.68% –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤!\n\n"
            "üì± –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ–ª–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:",
            reply_markup=main_keyboard()
        )
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        keyboard = [[InlineKeyboardButton("üöÄ –û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", web_app={'url': 'https://your-domain.com/mini-app.html'})]]
        await update.message.reply_text(
            "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ start: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

async def mini_app(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    try:
        user = update.effective_user
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_data = get_user_data(user.id)
        
        if not user_data:
            await update.message.reply_text("‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        mini_app_data = {
            'user_id': user.id,
            'nickname': user.username or user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            'balance': user_data['balance'],
            'total_deposits': user_data['total_deposits'],
            'total_mined': user_data['total_mined'],
            'pending_mining': user_data['pending_mining'],
            'mining_started': user_data['mining_started'],
            'mining_percentage': user_data['mining_percentage'],
            'referrals': user_data['referrals'],
            'referral_code': f"ref{user.id}",
            'wallet_address': WALLET_ADDRESS
        }
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –±—É–¥–µ—Ç API endpoint)
        response_text = (
            f"üìä –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:\n\n"
            f"üÜî ID: {mini_app_data['user_id']}\n"
            f"üë§ –ù–∏–∫: {mini_app_data['nickname']}\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å: {mini_app_data['balance']:.6f} TON\n"
            f"üè¶ –î–µ–ø–æ–∑–∏—Ç—ã: {mini_app_data['total_deposits']:.6f} TON\n"
            f"‚õèÔ∏è –ù–∞–∫–æ–ø–∞–Ω–æ: {mini_app_data['total_mined']:.6f} TON\n"
            f"üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: {mini_app_data['referrals']}\n"
            f"üîó –†–µ—Ñ. –∫–æ–¥: {mini_app_data['referral_code']}"
        )
        
        await update.message.reply_text(response_text)
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ mini_app: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        text = update.message.text
        
        if text == 'üè† –ì–ª–∞–≤–Ω–∞—è':
            await show_main(update)
        elif text == '‚õèÔ∏è –ú–∞–π–Ω–∏–Ω–≥':
            await show_mining(update)
        elif text == 'üë• –†–µ—Ñ–µ—Ä–∞–ª—ã':
            await show_referrals(update)
        elif text == 'üë§ –ü—Ä–æ—Ñ–∏–ª—å':
            await show_profile(update)
        elif text == 'üì± –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ':
            await mini_app(update, context)
        else:
            if context.user_data.get('waiting_for_wallet'):
                await process_wallet_input(update, context)
            else:
                await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –Ω–∏–∂–µ üëá", reply_markup=main_keyboard())
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_message: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")

async def show_main(update: Update):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É"""
    try:
        user = update.effective_user
        user_data = get_user_data(user.id)
        
        if user_data:
            available_balance = user_data['balance'] - user_data['pending_mining']
            
            text = (
                f"üìä –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å\n\n"
                f"üíº –ë–∞–ª–∞–Ω—Å: {available_balance:.6f} TON\n"
                f"üè¶ –î–µ–ø–æ–∑–∏—Ç—ã: {user_data['total_deposits']:.6f} TON\n"
                f"‚õèÔ∏è –ù–∞–∫–æ–ø–∞–Ω–æ: {user_data['total_mined']:.6f} TON\n"
                f"üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: {user_data['referrals']}\n\n"
                f"üí° –ü–æ–ª—É—á–∞–π—Ç–µ 1.12%-1.68% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤"
            )
        else:
            text = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"
        
        await update.message.reply_text(text, reply_markup=main_keyboard())
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ show_main: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")

async def show_mining(update: Update):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∞–π–Ω–∏–Ω–≥–∞"""
    try:
        user = update.effective_user
        user_data = get_user_data(user.id)
        
        if user_data:
            deposits = user_data['total_deposits']
            mined = user_data['total_mined']
            mining_started = user_data['mining_started']
            mining_percentage = user_data['mining_percentage']
            pending_mining = user_data['pending_mining']
            
            if deposits == 0:
                text = "‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤!\n\nüí° –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –º–∞–π–Ω–∏–Ω–≥!"
                keyboard = [[InlineKeyboardButton("üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", callback_data="deposit")]]
            else:
                can_mine, time_left, progress = await check_mining_progress(mining_started, mining_percentage, deposits)
                
                if can_mine:
                    text = (
                        f"‚úÖ –ú–∞–π–Ω–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω!\n\n"
                        f"üí∞ –î–µ–ø–æ–∑–∏—Ç: {deposits:.6f} TON\n"
                        f"üíé –î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–±–æ—Ä–∞: {pending_mining:.6f} TON\n"
                        f"‚õèÔ∏è –í—Å–µ–≥–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: {mined:.6f} TON\n\n"
                        f"üí° –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É"
                    )
                    keyboard = [[InlineKeyboardButton("‚ú® –°–æ–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É", callback_data="collect_mining")]]
                else:
                    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –Ω–∞–≥—Ä–∞–¥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    current_reward = deposits * mining_percentage * progress
                    
                    text = (
                        f"‚è≥ –ú–∞–π–Ω–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...\n\n"
                        f"üí∞ –î–µ–ø–æ–∑–∏—Ç: {deposits:.6f} TON\n"
                        f"üíé –¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä–∞–¥–∞: {current_reward:.6f} TON\n"
                        f"üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: {progress*100:.1f}%\n"
                        f"‚õèÔ∏è –í—Å–µ–≥–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: {mined:.6f} TON\n\n"
                        f"‚è∞ –°–ª–µ–¥—É—é—â–∏–π –º–∞–π–Ω–∏–Ω–≥ —á–µ—Ä–µ–∑: {time_left}\n"
                        f"üí° –ö–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 1.12%-1.68% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞"
                    )
                    keyboard = []
        else:
            text = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"
            keyboard = []
        
        await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ show_mining: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")

async def check_mining_progress(mining_started, mining_percentage, deposits):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –º–∞–π–Ω–∏–Ω–≥–∞ –∏ —Ä–∞—Å—á–µ—Ç —Ç–µ–∫—É—â–µ–π –Ω–∞–≥—Ä–∞–¥—ã"""
    if not mining_started or not mining_percentage:
        return True, "0 –º–∏–Ω—É—Ç", 1.0
    
    try:
        if isinstance(mining_started, str):
            mining_start_time = datetime.strptime(mining_started, '%Y-%m-%d %H:%M:%S')
        else:
            mining_start_time = mining_started
            
        current_time = datetime.now()
        time_diff = current_time - mining_start_time
        total_seconds_passed = time_diff.total_seconds()
        
        eight_hours_in_seconds = 8 * 3600
        
        if total_seconds_passed >= eight_hours_in_seconds:
            return True, "0 –º–∏–Ω—É—Ç", 1.0
        else:
            seconds_left = eight_hours_in_seconds - total_seconds_passed
            hours_left = int(seconds_left // 3600)
            minutes_left = int((seconds_left % 3600) // 60)
            seconds_left = int(seconds_left % 60)
            
            # –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç 0 –¥–æ 1
            progress = total_seconds_passed / eight_hours_in_seconds
            
            return False, f"{hours_left:02d}:{minutes_left:02d}:{seconds_left:02d}", progress
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –º–∞–π–Ω–∏–Ω–≥–∞: {e}")
        return True, "0 –º–∏–Ω—É—Ç", 1.0

async def show_referrals(update: Update):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É"""
    try:
        user = update.effective_user
        user_data = get_user_data(user.id)
        
        ref_code = f"ref{user.id}"
        ref_link = f"https://t.me/tonearnro_bot?start={ref_code}"
        
        referrals = user_data['referrals'] if user_data else 0
        
        text = (
            f"üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞\n\n"
            f"üîó –í–∞—à–∞ —Å—Å—ã–ª–∫–∞:\n{ref_link}\n\n"
            f"üìä –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ: {referrals}\n\n"
            f"üéÅ –ë–æ–Ω—É—Å—ã:\n"
            f"‚Ä¢ –í–∞–º –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞: 0.2 TON\n"
            f"‚Ä¢ –†–µ—Ñ–µ—Ä–∞–ª—É: 0.1 TON"
        )
        
        await update.message.reply_text(text)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ show_referrals: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")

async def show_profile(update: Update):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        user = update.effective_user
        user_data = get_user_data(user.id)
        
        if user_data:
            available_balance = user_data['balance'] - user_data['pending_mining']
            
            text = (
                f"üë§ –ü—Ä–æ—Ñ–∏–ª—å\n\n"
                f"üÜî ID: {user.id}\n"
                f"üë§ –ò–º—è: {user.first_name}\n"
                f"üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {datetime.now().strftime('%Y-%m-%d')}\n\n"
                f"üíº –ë–∞–ª–∞–Ω—Å: {available_balance:.6f} TON\n"
                f"üè¶ –î–µ–ø–æ–∑–∏—Ç—ã: {user_data['total_deposits']:.6f} TON\n"
                f"‚õèÔ∏è –ù–∞–∫–æ–ø–∞–Ω–æ: {user_data['total_mined']:.6f} TON\n"
                f"üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: {user_data['referrals']}"
            )
        else:
            text = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"
        
        keyboard = [
            [InlineKeyboardButton("üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", callback_data="deposit")],
            [InlineKeyboardButton("üí∏ –í—ã–≤–µ—Å—Ç–∏", callback_data="withdraw")]
        ]
        
        await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ show_profile: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")

# –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ...
# [–í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ó –ü–†–ï–î–´–î–£–©–ï–ì–û –ö–û–î–ê]
# handle_callback, show_deposit_info, check_withdraw_availability, 
# request_new_wallet, process_wallet_input, process_withdraw_with_wallet,
# create_withdrawal_request, collect_mining, start_mining,
# –∏ –≤—Å–µ –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã...

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        print("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
        init_db()
        
        print("üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...")
        application = Application.builder().token(TOKEN).build()
        
        print("üîÑ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤...")
        # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
        application.add_handler(CommandHandler("start", start))
        application.add_handler(CommandHandler("mini_app", mini_app))
        application.add_handler(CommandHandler("data", mini_app))  # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
        
        # –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
        application.add_handler(CommandHandler("admin", admin_panel))
        application.add_handler(CommandHandler("stats", admin_stats))
        application.add_handler(CommandHandler("users", admin_users))
        application.add_handler(CommandHandler("user", admin_user_info))
        application.add_handler(CommandHandler("addbalance", admin_add_balance))
        application.add_handler(CommandHandler("removebalance", admin_remove_balance))
        application.add_handler(CommandHandler("resetbalance", admin_reset_balance))
        application.add_handler(CommandHandler("resetmining", admin_reset_mining))
        application.add_handler(CommandHandler("addadmin", admin_add_admin))
        application.add_handler(CommandHandler("broadcast", admin_broadcast))
        application.add_handler(CommandHandler("export_users", admin_export_users))
        
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        application.add_handler(CallbackQueryHandler(handle_callback))
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        
        print("ü§ñ –ë–æ—Ç TonEarn –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
        print("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç...")
        
        application.run_polling()
        
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()

if __name__ == '__main__':
    main()
